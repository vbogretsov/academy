@using Academy.Presentation.ViewModels
@model Academy.Presentation.ViewModels.QuestionViewModel

@{
    var answersId = String.Format("answersFor{0}", Model.Id);
    var newAnswerId = String.Format("newAnswerFor{0}", Model.Id);
    const string addAnswerText = "Add answer";
    var addAnswerId = String.Format("addAnswerFor{0}", Model.Id);
    var showAnswersId = String.Format("showAnswersFor{0}", Model.Id);
    const string showAnswersText = "Show answers";
    const string postedText = "Posted: ";
    var fullUserName = String.Format(
        "{0} {1} {2}",
        Model.Author.Email,
        Model.Author.FirstName,
        Model.Author.LastName);
    var answerTemplate = new AnswerViewModel()
        {
            QuestionId = Model.Id
        };
    var questionId = String.Format("questionId{0}", Model.Id);
    var removeQuestionId = String.Format("removeQuestion{0}", Model.Id);
    var removeQuestionText = "Remove text";
}

<div class="text-block" id="@questionId">
    <div class="page-header">
        <span class="label">
            @fullUserName
        </span>
    </div>
    <div class="text-block-header">
        <h4>@Model.Title</h4>
    </div>
    <div class="text-block-body">
        @Model.Text
    </div>
    <div class="text-block-footer">
        <b>Disciplines</b>:
        @foreach (var discipline in Model.Disciplines)
        {
            <span class="label font-small">@discipline.Name</span>
        }
        <div>
            <span>
                <b>@postedText</b>
                @Model.PostedDate
            </span>
            <div class="pull-right">
                @if (User.IsInRole("Admin"))
                {
                    <button class="btn btn-mini btn-danger" id="@removeQuestionId">
                        @removeQuestionText
                    </button>
                }
                @if (Request.IsAuthenticated)
                {
                    <button class="btn btn-mini btn-primary" id="@addAnswerId">
                        @addAnswerText
                    </button>
                }
                <button class="btn btn-mini" id="@showAnswersId" style="margin-right: 10px">
                    @showAnswersText
                </button>
            </div>
        </div>
    </div>
</div>
<div id="@newAnswerId" class="text-block hide">
    <div class="text-block-body">
        @{
            Html.RenderPartial("Forms/AddAnswerForm", answerTemplate);
        }
    </div>
</div>
<div id="@answersId" class="hide" />

<script type="text/javascript">
    $(function () {
        $('#@removeQuestionId').click(function () {
            $.ajax({
                url: '@Url.Action("RemoveQuestion", "Question", new {id = Model.Id})',
                type: 'post',
                success: function () {
                    $('#@questionId').remove();
                }
            });
        });
        $('#@addAnswerId').click(function () {
            $('#@newAnswerId').slideToggle('fast');
        });
        $('#@showAnswersId').click(function () {
            if ($('#@answersId').is(':empty')) {
                $.ajax({
                    url: '@Url.Action("GetQuestionAnswers", "Answer", new {questionId = Model.Id})',
                    success: function(page) {
                        $('#@answersId').html(page);
                    }
                });
            }
            $('#@answersId').slideToggle('fast');
        });
    })
</script>